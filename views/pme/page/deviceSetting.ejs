<%- include(headerPath) %>
<div class="container-fluid flex-grow-1 container-p-y">
  <div class="row g-6">
    <div class="col-md-12 col-xxl-12">
      <div class="card">
        <div class="d-flex align-items-end row">
          <div class="col-md-9 order-2 order-md-1">
            <div class="card-body">
              <h4 class="card-title mb-4"><i class="ri-settings-5-line ri-26px"></i> Devices Setting</h4>
              <p class="mb-0">Halaman ini digunakan untuk mengatur parameter dasar power meter guna memicu alarm apabila melebihi batas yang ditentukan.</p>
              <p><i>This page is used to configure the basic parameters of the power meter to trigger an alarm if it exceeds the specified limit.</i></p>
            </div>
          </div>
          <div class="col-md-3 text-center text-md-end order-1 order-md-2">
            <div class="card-body pb-0 px-0 pt-0">
              <img
                src="/assets/img/illustrations/setting.jpeg"
                height="200"
                class="scaleX-n1-rtl"
                alt="Setting"/>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xxl-12 col-sm-12">
      <div class="card">
        <div class="card-body table-responsive">
          <table class="table" id="table">
            <thead>
              <tr>
                  <th rowspan="2">Device Details</th>
                  <th colspan="4" class="text-center">Limiter</th>
                  <th rowspan="2">Others</th>
                  <th rowspan="2">Action</th>
              </tr>
              <tr>
                  <th>Voltage</th>
                  <th>Ampere</th>
                  <th>daily kWh</th>
                  <th>daily kVARh</th>
              </tr>
            </thead>
            <tbody class="table-border-bottom-0">
            <% data.deviceList.forEach(device => { %>
              <tr>
                <td>
                  <ul class="list-unstyled mb-6">
                    <li class="mb-2">
                      <span class="h6 me-1"><%= device.showname %></span>
                    </li>
                    <li class="mb-2">
                      <span><%= device.conf %></span>
                    </li>
                    <li class="mb-2">
                      <% if (device.comtype === 'TCP/IP') { %>
                        <span><%= device.ipnum %>:<%= device.port %> ID:<%= device.unit_id %></span>
                      <% } else if (device.comtype === 'USB') { %>
                        <span>Port: <%= device.comport %>, Baudrate: <%= device.baudrate %>, Parity: <%= device.parity %>, Data Bits: <%= device.databits %>, Stop Bits: <%= device.stopbits %></span>
                      <% } %>
                    </li>
                  </ul>
                </td>
                <td>
                  <ul class="list-unstyled mb-6">
                    <li class="mb-2">
                      <span class="h6 me-1">Min: </span>
                      <span><%= (Number(device.v_down) || 0).toFixed(2) %></span>
                    </li>
                    <li class="mb-2">
                      <span class="h6 me-1">Max: </span>
                      <span><%= (Number(device.v_up) || 0).toFixed(2) %></span>
                    </li>
                  </ul>
                </td>
                <td>
                  <ul class="list-unstyled mb-6">
                    <li class="mb-2">
                      <span class="h6 me-1">Min: </span>
                      <span><%= (Number(device.i_down) || 0).toFixed(2) %></span>
                    </li>
                    <li class="mb-2">
                      <span class="h6 me-1">Max: </span>
                      <span><%= (Number(device.i_up) || 0).toFixed(2) %></span>
                    </li>
                  </ul>
                </td>
                <td>
                  <ul class="list-unstyled mb-6">
                    <li class="mb-2">
                      <span class="h6 me-1">Warn: </span>
                      <span><%= (Number(device.p_down) || 0).toFixed(2) %></span>
                    </li>
                    <li class="mb-2">
                      <span class="h6 me-1">Alert: </span>
                      <span><%= (Number(device.p_up) || 0).toFixed(2) %></span>
                    </li>
                  </ul>
                </td>
                <td>
                  <ul class="list-unstyled mb-6">
                    <li class="mb-2">
                      <span class="h6 me-1">Warn: </span>
                      <span><%= (Number(device.q_down) || 0).toFixed(2) %></span>
                    </li>
                    <li class="mb-2">
                      <span class="h6 me-1">Alert: </span>
                      <span><%= (Number(device.q_up) || 0).toFixed(2) %></span>
                    </li>
                  </ul>
                </td>
                <td>
                  <ul class="list-unstyled mb-6">
                    <li class="mb-2">
                      <span class="h6 me-1">Rasio: </span>
                      <span><%= (Number(device.persen) || 0).toFixed(2) %> %</span>
                    </li>
                    <li class="mb-2">
                      <span class="h6 me-1">Source Cal: </span>
                      <span><%= (Number(device.dash)) == 1 ? 'YES' : 'NO' %></span>
                    </li>
                  </ul>
                </td>
                <td>
                    <!-- Add any action buttons here -->
                    <button class="btn btn-primary" onclick="show_modal(<%= device.id %>)" >Edit</button>
                </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="edit_data">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
              <div class="row">
                <div class="col-12 col-md-12">
                  <div class="text-center mb-6">
                      <h4 class="mb-2">Edit Device</h4>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="mb-3 col-6 col-md-6">
                  <div class="form-floating form-floating-outline">
                    <input
                      type="text"
                      id="deviceName"
                      name="deviceName"
                      class="form-control"
                      value=""
                      placeholder="Device Name" />
                    <label for="deviceName">Device Name</label>
                  </div>
                </div>
                <div class="mb-3 col-6 col-md-6 fv-plugins-icon-container">
                  <div class="form-floating form-floating-outline">
                      <select id="deviceType" class="select2 form-select">
                        <% data.modbusList.forEach(modbus => { %>
                          <option value="<%- modbus.conf_name %>"><%- modbus.conf_name %></option>
                        <% }) %>
                      </select>
                      <label for="deviceType">Device Type</label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="mb-3 col-8 col-md-8">
                  <div class="form-floating form-floating-outline">
                    <select id="comType" class="select2 form-select">
                        <option value="TCP/IP">Modbus TCP/IP</option>
                        <option value="USB">Modbus RTU (USB)</option>
                    </select>
                    <label for="comType">Communication Type</label>
                  </div>
                </div>
                <div class="mb-3 col-4 col-md-4">
                  <div class="form-floating form-floating-outline">
                    <input
                      type="text"
                      id="unitId"
                      name="unitId"
                      class="form-control"
                      value=""
                      placeholder="Unit ID" />
                    <label for="unitId">Unit ID</label>
                  </div>
                </div>
              </div>
              <div class="row" id="modbustcp" style="display: none;">
                <div class="mb-3 col-7 col-md-7">
                  <div class="form-floating form-floating-outline">
                    <input
                      type="text"
                      id="ip"
                      name="ip"
                      class="form-control"
                      value=""
                      placeholder="Device Name" />
                    <label for="ip">IP</label>
                  </div>
                </div>
                <div class="mb-3 col-5 col-md-5">
                  <div class="form-floating form-floating-outline">
                    <input
                      type="number"
                      id="port"
                      name="port"
                      class="form-control"
                      value=""
                      placeholder="Port" />
                    <label for="port">Port</label>
                  </div>
                </div>
              </div>
              <div class="row" id="modbusrtu" style="display: none;">
                <div class="mb-3 col-6 col-md-6">
                  <div class="form-floating form-floating-outline">
                    <input
                      type="text"
                      id="comport"
                      name="comport"
                      class="form-control"
                      value=""
                      placeholder="COM PORT" />
                    <label for="comport">COM PORT</label>
                  </div>
                </div>
                <div class="mb-3 col-6 col-md-6">
                  <div class="form-floating form-floating-outline">
                    <select id="baudrate" class="select2 form-select">
                        <option value="110">110</option>
                        <option value="300">300</option>
                        <option value="600">600</option>
                        <option value="1200">1200</option>
                        <option value="2400">2400</option>
                        <option value="4800">4800</option>
                        <option value="9600">9600</option>
                        <option value="14400">14400</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="57600">57600</option>
                        <option value="115200">115200</option>
                        <option value="128000">128000</option>
                        <option value="256000">256000</option>
                    </select>
                    <label for="baudrate">Baud Rate</label>
                  </div>
                </div>
                <div class="mb-3 col-4 col-md-4">
                  <div class="form-floating form-floating-outline">
                    <select id="parity" class="select2 form-select">
                        <option value="none">none</option>
                        <option value="odd">odd</option>
                        <option value="even">even</option>
                        <option value="mark">mark</option>
                        <option value="space">space</option>
                    </select>
                    <label for="parity">Parity</label>
                  </div>
                </div>
                <div class="mb-3 col-4 col-md-4">
                  <div class="form-floating form-floating-outline">
                    <select id="databits" class="select2 form-select">
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                    <label for="databits">Data bits</label>
                  </div>
                </div>
                <div class="mb-3 col-4 col-md-4">
                  <div class="form-floating form-floating-outline">
                    <select id="stopbits" class="select2 form-select">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                    <label for="stopbits">Stop bits</label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12 col-md-12">
                  <div class="text-center">
                      <h5 class="mb-2">Limiter</h5>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="mb-3 col-6 col-md-6">
                  <div class="form-floating form-floating-outline">
                    <input
                      type="number"
                      step="0.01"
                      id="minVoltage"
                      name="minVoltage"
                      class="form-control"
                      value=""
                      placeholder="Min Voltage" />
                    <label for="minVoltage">Min Voltage</label>
                  </div>
                </div>
                <div class="mb-3 col-6 col-md-6">
                  <div class="form-floating form-floating-outline">
                    <input
                      type="number"
                      step="0.01"
                      id="maxVoltage"
                      name="maxVoltage"
                      class="form-control"
                      value=""
                      placeholder="Max Voltage" />
                    <label for="maxVoltage">Max Voltage</label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="mb-3 col-6 col-md-6">
                  <div class="form-floating form-floating-outline">
                    <input
                      type="number"
                      step="0.01"
                      id="minAmpere"
                      name="minAmpere"
                      class="form-control"
                      value=""
                      placeholder="Min Ampere" />
                    <label for="minAmpere">Min Ampere</label>
                  </div>
                </div>
                <div class="mb-3 col-6 col-md-6">
                  <div class="form-floating form-floating-outline">
                    <input
                      type="number"
                      step="0.01"
                      id="maxAmpere"
                      name="maxAmpere"
                      class="form-control"
                      value=""
                      placeholder="Max Ampere" />
                    <label for="maxAmpere">Max Ampere</label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="mb-3 col-6 col-md-6">
                  <div class="form-floating form-floating-outline">
                    <input
                      type="number"
                      step="0.01"
                      id="warnkWh"
                      name="warnkWh"
                      class="form-control"
                      value=""
                      placeholder="Warning kWh" />
                    <label for="warnkWh">Warn kWh</label>
                  </div>
                </div>
                <div class="mb-3 col-6 col-md-6">
                  <div class="form-floating form-floating-outline">
                    <input
                      type="number"
                      step="0.01"
                      id="alertkWh"
                      name="alertkWh"
                      class="form-control"
                      value=""
                      placeholder="Alert kWh" />
                    <label for="alertkWh">Alert kWh</label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="mb-3 col-6 col-md-6">
                  <div class="form-floating form-floating-outline">
                    <input
                      type="number"
                      step="0.01"
                      id="warnkVARh"
                      name="warnkVARh"
                      class="form-control"
                      value=""
                      placeholder="Warning kVARh" />
                    <label for="warnkVARh">Warn kVARh</label>
                  </div>
                </div>
                <div class="mb-3 col-6 col-md-6">
                  <div class="form-floating form-floating-outline">
                    <input
                      type="number"
                      step="0.01"
                      id="alertkVARh"
                      name="alertkVARh"
                      class="form-control"
                      value=""
                      placeholder="Alert kVARh" />
                    <label for="alertkVARh">Alert kVARh</label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12 col-md-12">
                  <div class="text-center">
                      <h5 class="mb-2">Others</h5>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="mb-3 col-6 col-md-6">
                  <div class="form-floating form-floating-outline">
                    <input
                      type="number"
                      id="persen"
                      step="0.01"
                      name="persen"
                      class="form-control"
                      value=""
                      placeholder="kVARh ratio (%)" />
                    <label for="persen">kVARh ratio (%)</label>
                  </div>
                </div>
                <div class="mb-3 col-6 col-md-6 fv-plugins-icon-container">
                  <div class="form-floating form-floating-outline">
                      <select id="deviceDash" class="select2 form-select">
                          <option value="1">YES</option>
                          <option value="2">NO</option>
                      </select>
                      <label for="deviceDash">Source of Calculation</label>
                  </div>
                </div>
              </div>
              <div class="col-12 text-center d-flex flex-wrap justify-content-center gap-4 row-gap-4">
                <button type="submit" class="btn btn-primary" onclick="edit_data_exe()">Submit</button>
                <button
                  type="reset"
                  class="btn btn-outline-secondary"
                  data-bs-dismiss="modal"
                  aria-label="Close">
                  Cancel
                </button>
              </div>
            </div>
            <span class="text-red" id="edit_data_warning"></span>
        </div>
    </div>
</div>
<script type="text/javascript">
  document.getElementById('comType').addEventListener('change', function () {
    cek_dd(this.value)
  });

  function cek_dd(val){
    const selectedType = val;
    const modbustcp = document.getElementById('modbustcp');
    const modbusrtu = document.getElementById('modbusrtu');

    if (selectedType === 'TCP/IP') {
      modbustcp.style.display = 'flex';
      modbusrtu.style.display = 'none';
    } else if (selectedType === 'USB') {
      modbustcp.style.display = 'none';
      modbusrtu.style.display = 'flex';
    }
  }
  // Initialize visibility based on the default selected value
  document.getElementById('comType').dispatchEvent(new Event('change'));

  var editId;
  function show_modal(id) {
      editId = id;
      $('#edit_data').modal('show');
      axios.post('/pme/deviceDetail', { id: editId })
      .then((response) => {
          if (response.status === 200) {
            console.log(response.data)
              $('#deviceName').val(response.data.showname)
              $('#deviceType').val(response.data.conf).trigger('change')
              
              $('#comType').val(response.data.comtype).trigger('change')
              $('#unitId').val(response.data.unit_id)

              $('#comport').val(response.data.comport)
              $('#baudrate').val(response.data.baudrate).trigger('change')
              $('#parity').val(response.data.parity).trigger('change')
              $('#databits').val(response.data.databits).trigger('change')
              $('#stopbits').val(response.data.stopbits).trigger('change')
          
              $('#ip').val(response.data.ipnum)
              $('#port').val(response.data.port)

              $('#minVoltage').val(response.data.v_down)
              $('#maxVoltage').val(response.data.v_up)
              $('#minAmpere').val(response.data.i_down)
              $('#maxAmpere').val(response.data.i_up)
              $('#warnkWh').val(response.data.p_down)
              $('#alertkWh').val(response.data.p_up)
              $('#warnkVARh').val(response.data.q_down)
              $('#alertkVARh').val(response.data.q_up)
              $('#persen').val(response.data.persen)
              $('#deviceDash').val(response.data.dash).trigger('change')
              cek_dd(response.data.comtype)
              $('#edit_data_warning').html('');
          }
      })
      .catch((error) => {
          if (error.response && error.response.status === 400) {
              $('#edit_data_warning').html(error.response.data.message);
          } else if (error.response && error.response.status === 500) {
              $('#edit_data_warning').html(error.response.data.message);
          } else {
              $('#edit_data_warning').html(error.message);
          }
      });
  }
  function edit_data_exe() {
      document.getElementById('edit_data_warning').innerHTML = '';
      axios.post('/pme/updateDevice', {
          deviceName: $('#deviceName').val(),
          deviceType: $('#deviceType').val(),

          comType: $('#comType').val(),

          ip: $('#ip').val(),
          port: $('#port').val(),

          comport: $('#comport').val(),
          baudrate: $('#baudrate').val(),
          parity: $('#parity').val(),
          databits: $('#databits').val(),
          stopbits: $('#stopbits').val(),

          unitId: $('#unitId').val(),
          minVoltage: $('#minVoltage').val(),
          maxVoltage: $('#maxVoltage').val(),
          minAmpere: $('#minAmpere').val(),
          maxAmpere: $('#maxAmpere').val(),
          warnkWh: $('#warnkWh').val(),
          alertkWh: $('#alertkWh').val(),
          warnkVARh: $('#warnkVARh').val(),
          alertkVARh: $('#alertkVARh').val(),
          persen: $('#persen').val(),
          deviceDash: $('#deviceDash').val(),
          id: editId
      })
      .then(function (response) {
          if (response.status === 201) {
              document.getElementById('edit_data_warning').innerHTML = '';
              $('#edit_data').modal('hide');
              location.reload();
          }
      })
      .catch(function (error) {
          if (error.response) {
              if (error.response.status === 400) {
                  document.getElementById('edit_data_warning').innerHTML = error.response.data.message;
              } else if (error.response.status === 500) {
                  document.getElementById('edit_data_warning').innerHTML = error.response.data.message;
              } else {
                  document.getElementById('edit_data_warning').innerHTML = error.message;
              }
          } else {
              document.getElementById('edit_data_warning').innerHTML = 'An unexpected error occurred.';
          }
      });
  }
</script>
<%- include(footerPath) %>