<%- include(headerPath) %>
<div class="container-fluid flex-grow-1 container-p-y">
<div class="row g-6">
  <div class="col-md-12 col-xxl-12">
    <div class="card">
      <div class="d-flex align-items-end row">
        <div class="col-md-9 order-2 order-md-1">
          <div class="card-body">
            <h4 class="card-title mb-4">Supported Devices</h4>
            <p class="mb-0">Halaman ini menampilkan alamat register data yang diambil secara real-time dari unit Power Meter. Setiap merek dan tipe tertentu memiliki alamatnya sendiri.</p>
            <p><i>This page displays the register addresses of data retrieved in real-time from the Power Meter unit. Each specific brand and type has its own address.</i></p>
          </div>
        </div>
        <div class="col-md-3 text-center text-md-end order-1 order-md-2">
          <div class="card-body pb-0 px-0 pt-0">
            <img
              src="/assets/img/illustrations/modbus.jpeg"
              height="200"
              class="scaleX-n1-rtl"
              alt="Modbus" />
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xxl-12 col-sm-12">
    <div class="card">
      <div class="card-body table-responsive">
        <table class="table" id="table">
          <thead>
            <tr>
                <th rowspan="2">Device Details</th>
                <th colspan="7" class="text-center">Registers | Length</th>
            </tr>
            <tr>
                <th>Voltage</th>
                <th>Ampere</th>
                <th>PQS</th>
                <th>f(Hz)</th>
                <th>pf</th>
                <th>thd</th>
                <th>Accumulated</th>
            </tr>
          </thead>
          <tbody class="table-border-bottom-0">
            <% data.modbusList.forEach(device => { %>
            <tr>
              <td>
                <ul class="list-unstyled mb-2">
                  <li class="mb-2">
                    <span class="h6 me-1"><%= device.conf_name %></span>
                  </li>
                  <li class="mb-2">
                    <span class="h6 me-1">Offside: </span>
                    <span><%= device.isvalid %></span>
                  </li>
                </ul>
                <button class="btn btn-primary" onclick="show_modal(<%= device.id %>)" ><i class="ri-settings-5-line"></i></button>
              </td>
              <td>
                <ul class="list-unstyled mb-6">
                  <li class="mb-2">
                    <span class="h6 me-1">Vab: </span>
                    <span><%= device.vab %> | <%= device.vab_data %></span>
                  </li>
                  <li class="mb-2">
                    <span class="h6 me-1">Vbc: </span>
                    <span><%= device.vbc %> | <%= device.vbc_data %></span>
                  </li>
                  <li class="mb-2">
                    <span class="h6 me-1">Vca: </span>
                    <span><%= device.vca %> | <%= device.vca_data %></span>
                  </li>
                </ul>
              </td>
              <td>
                <ul class="list-unstyled mb-6">
                  <li class="mb-2">
                    <span class="h6 me-1">Ia: </span>
                    <span><%= device.ia %> | <%= device.ia_data %></span>
                  </li>
                  <li class="mb-2">
                    <span class="h6 me-1">Ib: </span>
                    <span><%= device.ib %> | <%= device.ib_data %></span>
                  </li>
                  <li class="mb-2">
                    <span class="h6 me-1">Ic: </span>
                    <span><%= device.ic %> | <%= device.ic_data %></span>
                  </li>
                </ul>
              </td>
              <td>
                <ul class="list-unstyled mb-6">
                  <li class="mb-2">
                    <span class="h6 me-1">P (kW): </span>
                    <span><%= device.p %> | <%= device.p_data %></span>
                  </li>
                  <li class="mb-2">
                    <span class="h6 me-1">Q (kVAR): </span>
                    <span><%= device.q %> | <%= device.q_data %></span>
                  </li>
                  <li class="mb-2">
                    <span class="h6 me-1">S (kVA): </span>
                    <span><%= device.s %> | <%= device.s_data %></span>
                </ul>
              </td>
              <td>
                <ul class="list-unstyled mb-6">
                  <li class="mb-2">
                    <span class="h6 me-1">f (Hz): </span>
                    <span><%= device.f %> | <%= device.f_data %></span>
                  </li>
                </ul>
              </td>
              <td>
                <ul class="list-unstyled mb-6">
                  <li class="mb-2">
                    <span class="h6 me-1">pf a: </span>
                    <span><%= device.pfa %> | <%= device.pfa_data %></span>
                  </li>
                  <li class="mb-2">
                    <span class="h6 me-1">pf b: </span>
                    <span><%= device.pfb %> | <%= device.pfb_data %></span>
                  </li>
                  <li class="mb-2">
                    <span class="h6 me-1">pf c: </span>
                    <span><%= device.pfc %> | <%= device.pfc_data %></span>
                  </li>
                </ul>
              </td>
              <td>
                <ul class="list-unstyled mb-6">
                  <li class="mb-2">
                    <span class="h6 me-1">thd a: </span>
                    <span><%= device.thda %> | <%= device.thda_data %></span>
                  </li>
                  <li class="mb-2">
                    <span class="h6 me-1">thd b: </span>
                    <span><%= device.thdb %> | <%= device.thdb_data %></span>
                  </li>
                  <li class="mb-2">
                    <span class="h6 me-1">thd c: </span>
                    <span><%= device.thdc %> | <%= device.thdc_data %></span>
                  </li>
                </ul>
              </td>
              <td>
                <ul class="list-unstyled mb-6">
                  <li class="mb-2">
                    <span class="h6 me-1">kWh: </span>
                    <span><%= device.ap %> | <%= device.ap_data %></span>
                  </li>
                  <li class="mb-2">
                    <span class="h6 me-1">kVARh: </span>
                    <span><%= device.aq %> | <%= device.aq_data %></span>
                  </li>
                </ul>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="edit_data">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-body">
            <div class="row">
              <div class="col-12 col-md-12">
                <div class="text-center mb-6">
                    <h4 class="mb-2">Register Offside</h4>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="mb-3 col-12 col-md-12">
                <div class="form-floating form-floating-outline">
                  <input
                    type="text"
                    id="isvalid"
                    name="isvalid"
                    class="form-control"
                    value=""
                    placeholder="0" />
                  <label for="isvalid">Offside</label>
                </div>
              </div>
            </div>
            <div class="col-12 text-center d-flex flex-wrap justify-content-center gap-4 row-gap-4">
              <button type="submit" class="btn btn-primary" onclick="edit_data_exe()">Submit</button>
              <button
                type="reset"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal"
                aria-label="Close">
                Cancel
              </button>
            </div>
          </div>
          <span class="text-red" id="edit_data_warning"></span>
      </div>
  </div>
</div>
<script type="text/javascript">
  var editId;
  function show_modal(id) {
    editId = id;
    $('#edit_data').modal('show');
  }
  function edit_data_exe() {
      document.getElementById('edit_data_warning').innerHTML = '';
      axios.post('/pme/updateModbus', {
          offside: $('#isvalid').val(),
          id: editId
      })
      .then(function (response) {
          if (response.status === 201) {
              document.getElementById('edit_data_warning').innerHTML = '';
              $('#edit_data').modal('hide');
              location.reload();
          }
      })
      .catch(function (error) {
          if (error.response) {
              if (error.response.status === 400) {
                  document.getElementById('edit_data_warning').innerHTML = error.response.data.message;
              } else if (error.response.status === 500) {
                  document.getElementById('edit_data_warning').innerHTML = error.response.data.message;
              } else {
                  document.getElementById('edit_data_warning').innerHTML = error.message;
              }
          } else {
              document.getElementById('edit_data_warning').innerHTML = 'An unexpected error occurred.';
          }
      });
  }
</script>
<%- include(footerPath) %>