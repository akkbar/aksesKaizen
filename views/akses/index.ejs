<!-- <%- include(headerPath) %>
<div class="container-fluid flex-grow-1 container-p-y">
    <div class="row g-6">
        <div class="col-12 col-md-12 col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Active Stream</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <% data.url.forEach(stream => { %>
                            <div class="col-12 col-md-6 col-lg-6">
                                <img src="<%= stream.proxyUrl %>" class="img-fluid" style="max-height: 400px;" />
                            </div>
                        <% }) %>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<%- include(footerPath) %> -->


<%- include(headerPath) %>
<div class="container-fluid flex-grow-1 container-p-y">
  <div class="row g-6">
    <div class="col-12">
      <div class="card">
        <div class="card-header"><h5 class="mb-0">Active Stream</h5></div>
        <div class="card-body">
          <!-- hls.js untuk HLS -->
        <script src="/assets/js/hls.js"></script>

          <div class="row">
  <% data.url.forEach(stream => { 
       const u = (stream.originalUrl || '').toLowerCase();
       const isHls = u.includes('.m3u8') || u.includes('/hls/');
       const isMjpeg = u.includes('/mjpeg/') || u.endsWith('.mjpg') || u.includes('mjpeg=1');
       const isJpeg = u.endsWith('.jpg') || u.endsWith('.jpeg') || u.includes('/jpeg/') || u.includes('/sjpeg/');
  %>
    <div class="col-12 col-md-6 col-lg-6 mb-4">
      <% if (stream.type === 'hls' || isHls) { %>
        <video id="vid_<%= stream.id %>" controls autoplay muted playsinline style="width:100%;max-height:400px;background:#000;"></video>
        <script>
          (function() {
            const video = document.getElementById('vid_<%= stream.id %>');
            const src = '<%= stream.proxyUrl %>';
            if (Hls.isSupported()) {
              const hls = new Hls({ lowLatencyMode: true });
              hls.loadSource(src);
              hls.attachMedia(video);
              hls.on(Hls.Events.ERROR, function (event, data) {
                if (data.fatal) {
                  switch (data.type) {
                    case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
                    case Hls.ErrorTypes.MEDIA_ERROR: hls.recoverMediaError(); break;
                    default: hls.destroy(); break;
                  }
                }
              });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
              video.src = src; // Safari/iOS
            }
          })();
        </script>
      <% } else if (stream.type === 'mjpeg' || isMjpeg) { %>
        <img src="<%= stream.proxyUrl %>" class="img-fluid" style="max-height:400px;" />
      <% } else if (stream.type === 'jpeg' || isJpeg) { %>
        <img id="jpg_<%= stream.id %>" src="<%= stream.proxyUrl %>?t=<%= Date.now() %>" class="img-fluid" style="max-height:400px;" />
        <script>
          (function(){
            const img = document.getElementById('jpg_<%= stream.id %>');
            setInterval(() => {
              const u = new URL(img.src, window.location.href);
              u.searchParams.set('t', Date.now().toString());
              img.src = u.toString();
            }, 1000);
          })();
        </script>
      <% } else { %>
        <!-- fallback terakhir: coba video dulu -->
        <video src="<%= stream.proxyUrl %>" controls autoplay muted playsinline style="width:100%;max-height:400px;background:#000;"></video>
      <% } %>
    </div>
  <% }) %>
</div>

        </div>
      </div>
    </div>
  </div>
</div>
<%- include(footerPath) %>
